<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiza PCAP: {{ filename }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .packet-details {
            max-height: 500px;
            overflow-y: auto;
        }
        pre {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Strona główna</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ filename }}</li>
            </ol>
        </nav>
        
        <h1 class="mb-4">Analiza pliku: {{ filename }}</h1>
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="row mb-4">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h4>Podsumowanie</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Łączna liczba pakietów:</strong> {{ stats.total_packets }}</p>
                                
                                <h5>Najczęściej występujące adresy IP:</h5>
                                <ul>
                                    {% for ip, count in stats.top_ips.items() %}
                                        <li>{{ ip }}: {{ count }} pakietów</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5>Protokoły:</h5>
                                <ul>
                                    {% for proto, count in stats.protocols.items() %}
                                        <li>{{ proto }}: {{ count }} pakietów</li>
                                    {% endfor %}
                                </ul>
                                
                                <h5>Najczęściej występujące porty:</h5>
                                <ul>
                                    {% for port, count in stats.top_ports.items() %}
                                        <li>{{ port }}: {{ count }} pakietów</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card chart-container">
                    <div class="card-header">
                        <h4>Protokoły</h4>
                    </div>
                    <div class="card-body">
                        <canvas id="protocolChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card chart-container">
                    <div class="card-header">
                        <h4>Najczęstsze porty</h4>
                    </div>
                    <div class="card-body">
                        <canvas id="portChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Szczegóły pakietów</h4>
                <a href="{{ url_for('download_file', filename=filename) }}" class="btn btn-primary">Pobierz JSON</a>
            </div>
            <div class="card-body packet-details">
                <div class="mb-3">
                    <input type="text" id="packetSearch" class="form-control" placeholder="Szukaj pakietów...">
                </div>
                
                <div class="accordion" id="packetsAccordion">
                    {% for packet in data %}
                        <div class="accordion-item packet-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#packet{{ packet.packet_number }}" aria-expanded="false">
                                    Pakiet #{{ packet.packet_number }} 
                                    {% if packet.ip %}
                                        - {{ packet.ip.src }} → {{ packet.ip.dst }}
                                        {% if packet.tcp %}
                                            - TCP Port {{ packet.tcp.sport }} → {{ packet.tcp.dport }}
                                        {% elif packet.udp %}
                                            - UDP Port {{ packet.udp.sport }} → {{ packet.udp.dport }}
                                        {% endif %}
                                    {% endif %}
                                    - {{ packet.time }}
                                </button>
                            </h2>
                            <div id="packet{{ packet.packet_number }}" class="accordion-collapse collapse" data-bs-parent="#packetsAccordion">
                                <div class="accordion-body">
                                    <pre>{{ packet | tojson(indent=2) }}</pre>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wyszukiwanie pakietów
        document.getElementById('packetSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const packetItems = document.querySelectorAll('.packet-item');
            
            packetItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Wykres protokołów
        const protocolCtx = document.getElementById('protocolChart').getContext('2d');
        const protocolChart = new Chart(protocolCtx, {
            type: 'pie',
            data: {
                labels: [{% for proto in stats.protocols %}'{{ proto }}',{% endfor %}],
                datasets: [{
                    data: [{% for proto, count in stats.protocols.items() %}{{ count }},{% endfor %}],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Wykres portów
        const portData = [
            {% for port, count in stats.top_ports.items() %}
                {% if loop.index <= 5 %}
                    {
                        port: {{ port }},
                        count: {{ count }}
                    },
                {% endif %}
            {% endfor %}
        ];
        
        const portCtx = document.getElementById('portChart').getContext('2d');
        const portChart = new Chart(portCtx, {
            type: 'bar',
            data: {
                labels: portData.map(item => `Port ${item.port}`),
                datasets: [{
                    label: 'Liczba pakietów',
                    data: portData.map(item => item.count),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
</body>
</html>